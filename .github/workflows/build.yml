name: 构建扩展程序

on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master, dev]
  workflow_dispatch:

jobs:
  build-for-chrome:
    name: 构建 Chrome 扩展程序
    runs-on: ubuntu-latest
    env:
      VITE_RUN_ID: ${{ github.run_number }}
      VITE_HASH_ID: ${{ github.sha }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: extension/package-lock.json

      - name: 安装依赖
        working-directory: extension
        run: npm ci

      - name: 构建扩展程序
        working-directory: extension
        run: npm run build:chrome

      - name: 打包为 ZIP 文件
        working-directory: extension
        run: npm run package:chrome

      - name: 上传构建工件
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: extension/3things-chrome.zip
          retention-days: 30

  build-for-firefox:
    name: 构建 Firefox 附加组件
    runs-on: ubuntu-latest
    env:
      VITE_RUN_ID: ${{ github.run_number }}
      VITE_HASH_ID: ${{ github.sha }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: extension/package-lock.json

      - name: 安装依赖
        working-directory: extension
        run: npm ci

      - name: 构建扩展程序
        working-directory: extension
        run: npm run build:firefox

      - name: 打包为 ZIP 文件
        working-directory: extension
        run: npm run package:firefox

      - name: 上传构建工件
        uses: actions/upload-artifact@v4
        with:
          name: firefox-addon
          path: extension/3things-firefox.zip
          retention-days: 30

  publish-to-chrome-webstore:
    name: 发布至 Chrome 应用商店
    runs-on: ubuntu-latest
    needs: build-for-chrome
    # 仅在 master 分支且不是 PR 时执行发布
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: 下载构建工件
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension
          path: ./artifacts

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: 安装 Chrome Web Store 上传工具
        run: npm install -g chrome-webstore-upload-cli

      - name: 上传扩展程序到 Chrome Web Store
        run: |
          chrome-webstore-upload upload \
            --source artifacts/3things-chrome.zip \
            --extension-id ${{ secrets.CHROME_EXTENSION_ID }} \
            --client-id ${{ secrets.CHROME_CLIENT_ID }} \
            --client-secret ${{ secrets.CHROME_CLIENT_SECRET }} \
            --refresh-token ${{ secrets.CHROME_REFRESH_TOKEN }}

  publish-to-firefox-addons:
    name: 发布至 Firefox 附加组件库
    runs-on: ubuntu-latest
    needs: build-for-firefox
    # 仅在 master 分支且不是 PR 时执行发布
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: 下载构建工件
        uses: actions/download-artifact@v4
        with:
          name: firefox-addon
          path: ./artifacts

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: 安装 web-ext 工具
        run: npm install -g web-ext

      - name: 上传附加组件到 Firefox Add-ons
        run: |
          web-ext sign \
            --source-dir artifacts \
            --artifacts-dir artifacts \
            --api-key ${{ secrets.FIREFOX_API_KEY }} \
            --api-secret ${{ secrets.FIREFOX_API_SECRET }} \
            --channel listed

  create-github-release:
    name: 创建 GitHub Release
    runs-on: ubuntu-latest
    needs: [build-for-chrome, build-for-firefox]
    # 仅在 master 分支且不是 PR 时执行发布
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    permissions:
      contents: write

    steps:
      - name: 下载 Chrome 构建工件
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension
          path: ./artifacts

      - name: 下载 Firefox 构建工件
        uses: actions/download-artifact@v4
        with:
          name: firefox-addon
          path: ./artifacts

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ## 3Things 浏览器扩展

            ### 安装方式

            **Chrome/Edge:**
            1. 下载 `3things-chrome.zip`
            2. 解压文件
            3. 打开浏览器扩展管理页面
            4. 启用开发者模式
            5. 加载已解压的扩展程序

            **Firefox:**
            1. 下载 `3things-firefox.zip`
            2. 访问 Firefox Add-ons 开发者页面
            3. 上传文件进行签名

            ### 变更
            - 查看提交记录了解详细变更
          files: |
            artifacts/3things-chrome.zip
            artifacts/3things-firefox.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
